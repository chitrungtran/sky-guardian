<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sky Guardian - Modular Architecture</title>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
        body { font-family: 'Nunito', sans-serif; background: #e0f2fe; }
        .cloud-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 100%); overflow: hidden; }
        .cloud { position: absolute; background: rgba(255, 255, 255, 0.8); border-radius: 50%; animation: floatCloud linear infinite; }
        @keyframes floatCloud { 0% { transform: translateX(-200px); } 100% { transform: translateX(100vw); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .canvas-container { border: 4px solid #fff; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .spinner { width: 24px; height: 24px; border: 4px solid rgba(0,0,0,0.1); border-left-color: #09f; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .avatar-container:hover .avatar-overlay { opacity: 1; }
        /* Hiệu ứng sự kiện */
        .event-card { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================================================================
        // MODULE 0: CORE & CONFIG & UTILS (CẤU HÌNH CƠ BẢN)
        // ==========================================================================================
        const firebaseConfig = { apiKey: "AIzaSyD-FAKE-KEY", authDomain: "demo.firebaseapp.com", projectId: "demo", storageBucket: "demo.appspot.com", messagingSenderId: "123", appId: "1:123:web:abc" };
        if (!firebase.apps.length) try { firebase.initializeApp(firebaseConfig); } catch (e) { console.warn("Firebase Mock Mode"); }
        const auth = firebase.auth(); const db = firebase.firestore();
        const apiKey = ""; 

        const DEFAULT_CONFIG = {
            planes: [
                { id: 'p1', name: 'Mô hình giấy', speed: 4, fireRate: 20, hp: 3, price: 0, color: '#EF4444', image: null }, 
                { id: 'p2', name: 'Chiến cơ Ghibli', speed: 6, fireRate: 15, hp: 5, price: 1000, color: '#3B82F6', image: null }, 
                { id: 'p3', name: 'Hủy diệt hạm', speed: 8, fireRate: 10, hp: 8, price: 5000, color: '#10B981', image: null } 
            ],
            items: [
                { id: 'w1', name: 'Súng máy cơ bản', type: 'weapon', price: 0, value: 1, image: null, description: 'Súng mặc định.' },
                { id: 'w2', name: 'Laser Plasma', type: 'weapon', price: 2000, value: 3, image: null, description: 'Bắn tia laser xuyên thấu.' },
                { id: 's1', name: 'Khiên Plasma', type: 'shield', price: 200, value: 5, image: null, description: 'Bảo vệ trong 5 giây.' },
                { id: 'b1', name: 'Bom Nguyên Tử', type: 'bomb', price: 500, value: 10, image: null, description: 'Xóa sổ mọi kẻ thù.' }
            ],
            events: [
                { id: 'ev1', name: 'Khuyến mãi nạp đầu', description: 'Tặng ngay 5000 vàng cho lần đăng nhập đầu tiên trong ngày!', active: true, bonusGold: 5000, type: 'login_bonus' }
            ]
        };

        const generateGeminiContent = async (prompt) => { /* ... Gemini Logic ... */ return "AI: Đang bảo trì."; };

        // --- ICONS (SVG) ---
        const IconBase = ({ d, size = 24, color = "currentColor", className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {Array.isArray(d) ? d.map((path, i) => <path key={i} d={path} />) : <path d={d} />}
            </svg>
        );
        const Icons = {
            Plane: (p) => <IconBase {...p} d="M2 12h20M12 2v20M4.5 10l-2.5 2 2.5 2M19.5 10l2.5 2-2.5 2" />, 
            Shield: (p) => <IconBase {...p} d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />,
            Bomb: (p) => <IconBase {...p} d={["M11 2a3 3 0 0 1 3 3v.5M7 11.5a5.5 5.5 0 1 0 10.8 1.5","M15 6l2-2"]} />,
            Zap: (p) => <IconBase {...p} d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />,
            Settings: (p) => <IconBase {...p} d={["M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z", "M12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"]} />,
            LogOut: (p) => <IconBase {...p} d={["M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4", "M16 17l5-5-5-5", "M21 12H9"]} />,
            User: (p) => <IconBase {...p} d={["M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2", "M12 3a4 4 0 1 0 0 8 4 4 0 0 0 0-8z"]} />,
            DollarSign: (p) => <IconBase {...p} d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />,
            Trophy: (p) => <IconBase {...p} d={["M8 21h8", "M12 17v4", "M7 4h10", "M17 4v3a5 5 0 0 1-10 0V4"]} />,
            ShoppingCart: (p) => <IconBase {...p} d={["M9 21a1 1 0 1 0 0 2 1 1 0 0 0 0-2z", "M20 21a1 1 0 1 0 0 2 1 1 0 0 0 0-2z", "M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"]} />,
            Play: (p) => <IconBase {...p} d="M5 3l14 9-14 9V3z" />,
            Edit: (p) => <IconBase {...p} d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />,
            Trash2: (p) => <IconBase {...p} d={["M3 6h18", "M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6", "M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"]} />,
            ShieldCheck: (p) => <IconBase {...p} d={["M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z", "M9 12l2 2 4-4"]} />,
            Lock: (p) => <IconBase {...p} d={["M4 11a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-9z", "M7 11V7a5 5 0 0 1 10 0v4"]} />,
            Mail: (p) => <IconBase {...p} d={["M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z", "M22 6l-10 7L2 6"]} />,
            Sparkles: (p) => <IconBase {...p} d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />,
            Camera: (p) => <IconBase {...p} d={["M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z", "M12 13a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"]} />, 
            Plus: (p) => <IconBase {...p} d={["M12 5v14", "M5 12h14"]} />,
            Upload: (p) => <IconBase {...p} d={["M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4", "M17 8l-5-5-5 5", "M12 3v12"]} />,
            Weapon: (p) => <IconBase {...p} d={["M6 9H2v2h4V9zm8-2h-2v4h2V7zm4-4h-2v8h2V3zM4 19h10v2H4v-2zm16-6h-4v2h4v-2z"]} />,
            Gift: (p) => <IconBase {...p} d={["M20 12v10H4V12", "M2 7h20v5H2z", "M12 22V7", "M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z", "M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"]} />,
        };

        const { useState, useEffect, useRef, useMemo } = React;
        const { Plane, Shield, Bomb, Zap, Settings, LogOut, User, DollarSign, Trophy, ShoppingCart, Play, Edit, Trash2, ShieldCheck, Lock, Mail, Sparkles, Camera, Plus, Upload, Weapon, Gift } = Icons; 

        // ==========================================================================================
        // MODULE 1: USER MANAGEMENT & DATABASE (QUẢN LÝ USER)
        // ==========================================================================================
        const MockDB = {
            users: {
                'admin_uid': { uid: 'admin_uid', username: 'admin', password: 'qazwsx@12A', email: 'admin@sky.com', role: 'admin', nickname: 'Admin Bất Tử', avatar: null, gold: 999999, level: 99, planes: ['p1', 'p2', 'p3'], currentPlane: 'p3', currentWeapon: 'w1', inventory: { shields: 99, bombs: 99 }, eventsParticipated: [] }
            },
            currentUser: null,
            login: async (u, p) => { /* ... Logic Login ... */ 
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        const usersArr = Object.values(MockDB.users);
                        const found = usersArr.find(usr => usr.username === u);
                        if (found && found.password === p) {
                            if (!found.currentWeapon) found.currentWeapon = 'w1';
                            if (!found.eventsParticipated) found.eventsParticipated = [];
                            MockDB.currentUser = found;
                            resolve(found);
                        } else reject("Sai thông tin!");
                    }, 500);
                });
            },
            register: async (u, p, e) => { /* ... Logic Register ... */ 
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        if (Object.values(MockDB.users).some(usr => usr.username === u)) return reject("Trùng username!");
                        const newUser = { uid: 'u_'+Date.now(), username: u, password: p, email: e, role: 'user', nickname: u, avatar: null, gold: 500, level: 1, exp: 0, planes: ['p1'], currentPlane: 'p1', currentWeapon: 'w1', inventory: { shields: 1, bombs: 4 }, eventsParticipated: [] };
                        MockDB.users[newUser.uid] = newUser;
                        MockDB.currentUser = newUser;
                        resolve(newUser);
                    }, 500);
                });
            },
            updateUser: (uid, data) => { if (MockDB.users[uid]) MockDB.users[uid] = { ...MockDB.users[uid], ...data }; },
            changePassword: async (uid, old, newP) => { /* ... */ return Promise.resolve(true); },
            resetPassword: async (e) => { return Promise.resolve("Đã gửi mail!"); }
        };

        const Module_Auth = ({ onLogin }) => {
            const [mode, setMode] = useState('login'); // login, register, forgot
            const [form, setForm] = useState({ u: '', p: '', e: '' });
            const [msg, setMsg] = useState({ type: '', text: '' });

            const submit = async (e) => {
                e.preventDefault();
                setMsg({ type: 'info', text: 'Đang xử lý...' });
                try {
                    let user;
                    if (mode === 'forgot') { setMsg({ type: 'success', text: await MockDB.resetPassword(form.e) }); return; }
                    if (mode === 'register') user = await MockDB.register(form.u, form.p, form.e);
                    else user = await MockDB.login(form.u, form.p);
                    onLogin(user);
                } catch (err) { setMsg({ type: 'error', text: err }); }
            };

            return (
                <div className="flex items-center justify-center min-h-screen relative z-10">
                    <div className="bg-white/90 backdrop-blur p-8 rounded-2xl shadow-xl w-96 border-2 border-white">
                        <div className="text-center mb-6"><div className="w-20 h-20 bg-blue-500 rounded-full mx-auto mb-4 flex items-center justify-center shadow-lg animate-bounce"><Plane size={40} color="white" /></div><h1 className="text-3xl font-bold text-gray-800">Sky Guardian</h1></div>
                        {msg.text && <div className={`p-2 rounded mb-4 text-sm font-bold ${msg.type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>{msg.text}</div>}
                        <form onSubmit={submit} className="space-y-4">
                            {mode !== 'forgot' && <div><label className="block text-sm font-bold text-gray-600">Username</label><input className="w-full p-2 border rounded" value={form.u} onChange={e=>setForm({...form, u: e.target.value})} required /></div>}
                            {(mode === 'register' || mode === 'forgot') && <div><label className="block text-sm font-bold text-gray-600">Email</label><input type="email" className="w-full p-2 border rounded" value={form.e} onChange={e=>setForm({...form, e: e.target.value})} required /></div>}
                            {mode !== 'forgot' && <div><label className="block text-sm font-bold text-gray-600">Password</label><input type="password" className="w-full p-2 border rounded" value={form.p} onChange={e=>setForm({...form, p: e.target.value})} required /></div>}
                            <button className="w-full py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">{mode === 'login' ? 'Đăng Nhập' : (mode === 'register' ? 'Đăng Ký' : 'Khôi Phục')}</button>
                        </form>
                        <div className="mt-4 text-center text-sm space-x-2">
                            {mode !== 'login' && <button onClick={()=>setMode('login')} className="text-blue-500 hover:underline">Đăng nhập</button>}
                            {mode !== 'register' && <button onClick={()=>setMode('register')} className="text-blue-500 hover:underline">Đăng ký</button>}
                            {mode !== 'forgot' && <button onClick={()=>setMode('forgot')} className="text-gray-500 hover:underline">Quên pass?</button>}
                        </div>
                    </div>
                </div>
            );
        };

        const Module_UserSettings = ({ user, onUpdate, onClose, onLogout }) => {
            /* ... (Giữ nguyên logic setting cũ nhưng gọn hơn) ... */
            return <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50"><div className="bg-white p-6 rounded-2xl w-96"><h2 className="font-bold text-xl mb-4">Cài đặt</h2><button onClick={onLogout} className="text-red-500">Đăng xuất</button><button onClick={onClose} className="ml-4">Đóng</button></div></div>;
        };

        // ==========================================================================================
        // MODULE 2: BASE GAME (ENGINE GAME)
        // ==========================================================================================
        const Module_Game = ({ user, config, onExit, onGameOver }) => {
            const canvasRef = useRef(null);
            const requestRef = useRef();
            const planeImagesRef = useRef({});
            
            const currentPlaneStats = config.planes.find(p => p.id === user.currentPlane) || config.planes[0];
            const currentWeapon = config.items.find(i => i.id === user.currentWeapon) || config.items[0];

            useEffect(() => {
                config.planes.forEach(p => { if (p.image) { const img = new Image(); img.src = p.image; planeImagesRef.current[p.id] = img; }});
            }, [config]);

            useEffect(() => {
                document.body.style.overflow = 'hidden';
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth > 600 ? 600 : window.innerWidth; canvas.height = window.innerHeight;

                let state = {
                    player: { x: canvas.width/2, y: canvas.height-100, w: 50, h: 50, hp: currentPlaneStats.hp || 3, color: currentPlaneStats.color },
                    bullets: [], enemies: [], particles: [], score: 0, gold: 0, frames: 0, gameOver: false
                };

                const keys = {};
                window.onkeydown = e => keys[e.code] = true; window.onkeyup = e => keys[e.code] = false;
                
                const loop = () => {
                    if (state.gameOver) {
                        ctx.fillStyle = 'rgba(0,0,0,0.7)'; ctx.fillRect(0,0,canvas.width, canvas.height);
                        ctx.fillStyle = 'white'; ctx.textAlign = 'center'; ctx.font = '30px Nunito'; ctx.fillText('GAME OVER', canvas.width/2, canvas.height/2);
                        return;
                    }
                    state.frames++;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    // Player Move
                    if (keys['ArrowLeft']) state.player.x -= currentPlaneStats.speed;
                    if (keys['ArrowRight']) state.player.x += currentPlaneStats.speed;
                    if (keys['ArrowUp']) state.player.y -= currentPlaneStats.speed;
                    if (keys['ArrowDown']) state.player.y += currentPlaneStats.speed;

                    // Draw Player
                    if (planeImagesRef.current[user.currentPlane]) ctx.drawImage(planeImagesRef.current[user.currentPlane], state.player.x - 25, state.player.y - 25, 50, 50);
                    else { ctx.fillStyle = state.player.color; ctx.fillRect(state.player.x - 25, state.player.y - 25, 50, 50); }

                    // Shoot
                    if (state.frames % currentPlaneStats.fireRate === 0) {
                        state.bullets.push({ x: state.player.x, y: state.player.y - 20, w: 4, h: 10, dmg: currentWeapon.value || 1, color: currentWeapon.id === 'w2' ? '#0f0' : 'orange' });
                    }

                    // Bullets logic
                    ctx.fillStyle = 'orange';
                    state.bullets.forEach((b, i) => {
                        b.y -= 10; ctx.fillStyle = b.color; ctx.fillRect(b.x, b.y, b.w, b.h);
                        if(b.y < 0) state.bullets.splice(i, 1);
                    });

                    // Enemy Logic (Simplified)
                    if (state.frames % 60 === 0) state.enemies.push({ x: Math.random() * canvas.width, y: -20, w: 30, h: 30, hp: 2 });
                    state.enemies.forEach((e, i) => {
                        e.y += 3; ctx.fillStyle = 'gray'; ctx.fillRect(e.x, e.y, e.w, e.h);
                        // Collision Bullet-Enemy
                        state.bullets.forEach((b, bi) => {
                            if (Math.hypot(b.x - e.x, b.y - e.y) < 20) {
                                e.hp -= b.dmg; state.bullets.splice(bi, 1);
                                if (e.hp <= 0) { state.enemies.splice(i, 1); state.score += 100; state.gold += 5; }
                            }
                        });
                        // Collision Player-Enemy
                        if (Math.hypot(state.player.x - e.x, state.player.y - e.y) < 30) {
                            state.player.hp--; state.enemies.splice(i, 1);
                            if (state.player.hp <= 0) { state.gameOver = true; onGameOver(state.score, state.gold); }
                        }
                    });

                    // HUD
                    ctx.fillStyle = 'black'; ctx.textAlign = 'left'; ctx.font = '20px Nunito'; ctx.fillText(`Score: ${state.score} | HP: ${state.player.hp}`, 10, 30);

                    requestRef.current = requestAnimationFrame(loop);
                };
                requestRef.current = requestAnimationFrame(loop);
                return () => { document.body.style.overflow = 'auto'; cancelAnimationFrame(requestRef.current); };
            }, []);

            return <div className="fixed inset-0 bg-black flex items-center justify-center"><div className="canvas-container bg-blue-200"><canvas ref={canvasRef}></canvas></div><button onClick={onExit} className="absolute top-4 right-4 bg-red-500 text-white p-2 rounded">Thoát</button></div>;
        };

        // ==========================================================================================
        // MODULE 3: SHOP & INVENTORY (MÁY BAY & TRANG BỊ)
        // ==========================================================================================
        const Module_Shop = ({ user, config, onPurchase, onBack }) => {
            const weapons = config.items.filter(i => i.type === 'weapon');
            const supports = config.items.filter(i => i.type !== 'weapon');

            const ItemCard = ({ item, isPlane = false }) => {
                const isOwned = isPlane ? user.planes.includes(item.id) : false;
                const isEquipped = isPlane ? user.currentPlane === item.id : user.currentWeapon === item.id;
                
                return (
                    <div className={`bg-white border rounded-xl p-4 flex flex-col justify-between ${isEquipped ? 'border-green-500 bg-green-50' : ''}`}>
                        <div className="text-center mb-2">
                            <div className="h-16 flex items-center justify-center">{item.image ? <img src={item.image} className="h-full object-contain"/> : (isPlane ? <Plane/> : <Weapon/>)}</div>
                            <div className="font-bold">{item.name}</div>
                            <div className="text-xs text-gray-500">{isPlane ? `HP: ${item.hp}` : `DMG: ${item.value}`}</div>
                        </div>
                        {isPlane ? (
                            isOwned ? <button disabled={isEquipped} onClick={() => onPurchase('equip_plane', item)} className="bg-blue-100 text-blue-600 w-full py-1 rounded">{isEquipped ? 'Đang dùng' : 'Trang bị'}</button>
                            : <button onClick={() => onPurchase('buy_plane', item)} className="bg-yellow-400 text-black w-full py-1 rounded">Mua {item.price}</button>
                        ) : (
                            item.type === 'weapon' ? 
                            <button disabled={isEquipped} onClick={() => onPurchase('buy_item', item)} className="bg-orange-500 text-white w-full py-1 rounded">{isEquipped ? 'Đang dùng' : `Mua ${item.price}`}</button>
                            : <button onClick={() => onPurchase('buy_item', item)} className="bg-purple-500 text-white w-full py-1 rounded">Mua (+1) {item.price}</button>
                        )}
                    </div>
                );
            };

            return (
                <div className="bg-white/95 rounded-xl shadow-2xl p-6 w-full max-w-5xl h-[80vh] flex flex-col relative z-20">
                    <div className="flex justify-between border-b pb-4 mb-4">
                        <h2 className="text-2xl font-bold flex gap-2"><ShoppingCart/> Cửa Hàng</h2>
                        <div className="font-bold text-yellow-600"><DollarSign className="inline"/> {user.gold} <button onClick={onBack} className="ml-4 text-gray-500">Đóng</button></div>
                    </div>
                    <div className="overflow-y-auto space-y-6 p-2">
                        <section>
                            <h3 className="font-bold text-gray-700 mb-2">Máy Bay</h3>
                            <div className="grid grid-cols-3 gap-4">{config.planes.map(p => <ItemCard key={p.id} item={p} isPlane={true} />)}</div>
                        </section>
                        <section>
                            <h3 className="font-bold text-gray-700 mb-2">Vũ Khí</h3>
                            <div className="grid grid-cols-3 gap-4">{weapons.map(w => <ItemCard key={w.id} item={w} />)}</div>
                        </section>
                        <section>
                            <h3 className="font-bold text-gray-700 mb-2">Hỗ Trợ</h3>
                            <div className="grid grid-cols-3 gap-4">{supports.map(s => <ItemCard key={s.id} item={s} />)}</div>
                        </section>
                    </div>
                </div>
            );
        };

        // ==========================================================================================
        // MODULE 4: EVENTS (SỰ KIỆN GAME)
        // ==========================================================================================
        const Module_Event = ({ user, config, onClaimEvent }) => {
            const activeEvents = config.events.filter(e => e.active);
            if (activeEvents.length === 0) return null;

            return (
                <div className="space-y-4">
                    {activeEvents.map(evt => {
                        const participated = user.eventsParticipated && user.eventsParticipated.includes(evt.id);
                        return (
                            <div key={evt.id} className="event-card p-4 rounded-xl shadow-lg border border-pink-200 relative overflow-hidden">
                                <div className="absolute top-0 right-0 p-2 opacity-20"><Gift size={60} /></div>
                                <div className="relative z-10">
                                    <h3 className="font-bold text-pink-800 flex items-center gap-2"><Sparkles size={16}/> {evt.name}</h3>
                                    <p className="text-xs text-pink-700 mb-3">{evt.description}</p>
                                    {participated ? (
                                        <button disabled className="bg-gray-200 text-gray-500 px-3 py-1 rounded text-xs font-bold w-full">Đã nhận</button>
                                    ) : (
                                        <button onClick={() => onClaimEvent(evt)} className="bg-pink-600 hover:bg-pink-700 text-white px-3 py-1 rounded text-xs font-bold w-full shadow animate-pulse">Nhận Quà</button>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        // ==========================================================================================
        // MODULE 5: ADMIN MANAGEMENT (QUẢN LÝ TỔNG)
        // ==========================================================================================
        const Module_Admin = ({ user, config, allUsers, onUpdateConfig, onUpdateUser, onExit }) => {
            const [tab, setTab] = useState('users');
            
            const handleUpload = (e, listName, idx) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onloadend = () => {
                    const newList = [...config[listName]];
                    newList[idx].image = reader.result;
                    onUpdateConfig({ [listName]: newList });
                };
                reader.readAsDataURL(file);
            };

            const toggleEvent = (idx) => {
                const newEvts = [...config.events];
                newEvts[idx].active = !newEvts[idx].active;
                onUpdateConfig({ events: newEvts });
            };

            const deleteItem = (idx) => {
                const newItems = [...config.items];
                newItems.splice(idx, 1);
                onUpdateConfig({ items: newItems });
            };

            return (
                <div className="fixed inset-0 bg-gray-900/90 z-50 flex">
                    <div className="w-64 bg-black text-white p-6">
                        <h2 className="text-xl font-bold mb-8 text-yellow-400">ADMIN PANEL</h2>
                        <nav className="space-y-4">
                            <button onClick={()=>setTab('users')} className={`block w-full text-left ${tab==='users'?'text-blue-400':''}`}>Quản lý User</button>
                            <button onClick={()=>setTab('planes')} className={`block w-full text-left ${tab==='planes'?'text-blue-400':''}`}>Máy Bay</button>
                            <button onClick={()=>setTab('items')} className={`block w-full text-left ${tab==='items'?'text-blue-400':''}`}>Vật Phẩm</button>
                            <button onClick={()=>setTab('events')} className={`block w-full text-left ${tab==='events'?'text-blue-400':''}`}>Sự Kiện</button>
                        </nav>
                        <button onClick={onExit} className="mt-8 text-red-500 border border-red-500 px-4 py-2 rounded">Thoát</button>
                    </div>
                    <div className="flex-1 bg-gray-100 p-8 overflow-y-auto text-black">
                        {tab === 'users' && (
                            <div>
                                <h3 className="font-bold text-xl mb-4">Danh sách User</h3>
                                {Object.values(allUsers).map(u => (
                                    <div key={u.uid} className="bg-white p-4 mb-2 rounded shadow flex justify-between">
                                        <div><b>{u.nickname}</b> (Gold: {u.gold})</div>
                                        <input type="number" className="border w-20" defaultValue={u.gold} onBlur={(e)=>onUpdateUser(u.uid, {gold: parseInt(e.target.value)})} />
                                    </div>
                                ))}
                            </div>
                        )}
                        {tab === 'planes' && (
                            <div>
                                <h3 className="font-bold text-xl mb-4">Danh sách Máy Bay</h3>
                                <div className="grid grid-cols-2 gap-4">
                                    {config.planes.map((p, i) => (
                                        <div key={p.id} className="bg-white p-4 rounded shadow">
                                            <div className="flex gap-2 mb-2">
                                                <div className="w-10 h-10 border relative cursor-pointer" onClick={()=>document.getElementById(`up_p_${i}`).click()}>
                                                    {p.image ? <img src={p.image} className="w-full h-full object-contain"/> : <span className="text-xs">Upload</span>}
                                                    <input type="file" id={`up_p_${i}`} hidden onChange={(e)=>handleUpload(e, 'planes', i)} />
                                                </div>
                                                <input className="font-bold border-b" value={p.name} onChange={(e)=>{const n=[...config.planes];n[i].name=e.target.value;onUpdateConfig({planes:n})}} />
                                            </div>
                                            <div className="grid grid-cols-2 gap-2 text-sm">
                                                <div>Speed: <input className="border w-12" type="number" value={p.speed} onChange={(e)=>{const n=[...config.planes];n[i].speed=Number(e.target.value);onUpdateConfig({planes:n})}} /></div>
                                                <div>HP: <input className="border w-12" type="number" value={p.hp} onChange={(e)=>{const n=[...config.planes];n[i].hp=Number(e.target.value);onUpdateConfig({planes:n})}} /></div>
                                                <div>Price: <input className="border w-12" type="number" value={p.price} onChange={(e)=>{const n=[...config.planes];n[i].price=Number(e.target.value);onUpdateConfig({planes:n})}} /></div>
                                            </div>
                                        </div>
                                    ))}
                                    <button onClick={()=>onUpdateConfig({planes:[...config.planes, {id:'p'+Date.now(), name:'New Plane', speed:5, hp:5, price:1000}]})} className="bg-green-500 text-white rounded p-4 flex items-center justify-center font-bold text-xl">+</button>
                                </div>
                            </div>
                        )}
                        {tab === 'items' && (
                            <div>
                                <h3 className="font-bold text-xl mb-4">Danh sách Vật Phẩm</h3>
                                <div className="grid grid-cols-2 gap-4">
                                    {config.items.map((it, i) => (
                                        <div key={it.id} className="bg-white p-4 rounded shadow relative group">
                                            <button onClick={()=>deleteItem(i)} className="absolute top-2 right-2 text-red-500 bg-red-100 p-1 rounded hover:bg-red-200"><Trash2 size={14}/></button>
                                            <div className="flex gap-2 mb-2">
                                                <div className="w-10 h-10 border relative cursor-pointer" onClick={()=>document.getElementById(`up_i_${i}`).click()}>
                                                    {it.image ? <img src={it.image} className="w-full h-full object-contain"/> : <span className="text-xs">Upload</span>}
                                                    <input type="file" id={`up_i_${i}`} hidden onChange={(e)=>handleUpload(e, 'items', i)} />
                                                </div>
                                                <div className="flex-1">
                                                    <input className="font-bold border-b w-full" value={it.name} onChange={(e)=>{const n=[...config.items];n[i].name=e.target.value;onUpdateConfig({items:n})}} />
                                                    <select className="text-xs border mt-1" value={it.type} onChange={(e)=>{const n=[...config.items];n[i].type=e.target.value;onUpdateConfig({items:n})}}>
                                                        <option value="weapon">Vũ khí</option>
                                                        <option value="shield">Khiên</option>
                                                        <option value="bomb">Bom</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-2 text-sm">
                                                <div>Giá: <input className="border w-16" type="number" value={it.price} onChange={(e)=>{const n=[...config.items];n[i].price=Number(e.target.value);onUpdateConfig({items:n})}} /></div>
                                                <div>{it.type==='weapon'?'DMG':(it.type==='shield'?'Time':'Power')}: <input className="border w-12" type="number" value={it.value} onChange={(e)=>{const n=[...config.items];n[i].value=Number(e.target.value);onUpdateConfig({items:n})}} /></div>
                                            </div>
                                            <textarea className="w-full text-xs border mt-2 p-1 h-12" value={it.description} onChange={(e)=>{const n=[...config.items];n[i].description=e.target.value;onUpdateConfig({items:n})}}></textarea>
                                        </div>
                                    ))}
                                    <button onClick={()=>onUpdateConfig({items:[...config.items, {id:'i'+Date.now(), name:'New Item', type:'weapon', price:500, value:1, description:'New item'}]})} className="bg-purple-500 text-white rounded p-4 flex items-center justify-center font-bold text-xl">+</button>
                                </div>
                            </div>
                        )}
                        {tab === 'events' && (
                            <div>
                                <h3 className="font-bold text-xl mb-4">Quản lý Sự Kiện</h3>
                                {config.events.map((ev, i) => (
                                    <div key={ev.id} className="bg-white p-4 mb-2 rounded shadow flex justify-between items-center">
                                        <div>
                                            <div className="font-bold">{ev.name}</div>
                                            <div className="text-sm text-gray-500">{ev.description}</div>
                                            <div className="text-sm font-bold text-yellow-600">Thưởng: {ev.bonusGold} Gold</div>
                                        </div>
                                        <button onClick={()=>toggleEvent(i)} className={`px-4 py-2 rounded font-bold ${ev.active ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600'}`}>
                                            {ev.active ? 'Đang chạy' : 'Đã tắt'}
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                        {/* Tab Items làm tương tự... */}
                    </div>
                </div>
            );
        };

        // ==========================================================================================
        // APP ORCHESTRATOR (TRÌNH ĐIỀU PHỐI)
        // ==========================================================================================
        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('login'); 
            const [config, setConfig] = useState(DEFAULT_CONFIG);
            const [showSettings, setShowSettings] = useState(false);

            const handleLogin = (u) => { setUser(u); setView('dashboard'); };
            const handleLogout = () => { setUser(null); setView('login'); setShowSettings(false); };
            
            const handlePurchase = (type, item) => {
                const newUser = { ...user };
                if (type === 'buy_plane' || type === 'buy_item') {
                    if (user.gold >= item.price) {
                        newUser.gold -= item.price;
                        if (type === 'buy_plane') newUser.planes.push(item.id);
                        else if (item.type === 'weapon') { newUser.currentWeapon = item.id; } // Mua súng là trang bị luôn
                        else if (item.type === 'shield') newUser.inventory.shields++;
                        else if (item.type === 'bomb') newUser.inventory.bombs++;
                        alert(`Mua thành công: ${item.name}`);
                    } else return alert("Không đủ tiền!");
                } else if (type === 'equip_plane') {
                    newUser.currentPlane = item.id;
                }
                setUser(newUser); MockDB.updateUser(user.uid, newUser);
            };

            const handleClaimEvent = (evt) => {
                const newUser = { ...user };
                newUser.gold += evt.bonusGold;
                if (!newUser.eventsParticipated) newUser.eventsParticipated = [];
                newUser.eventsParticipated.push(evt.id);
                setUser(newUser); MockDB.updateUser(user.uid, newUser);
                alert(`Đã nhận thưởng sự kiện: +${evt.bonusGold} Gold!`);
            };

            if (!user) return <Module_Auth onLogin={handleLogin} />;
            if (view === 'game') return <Module_Game user={user} config={config} onExit={()=>setView('dashboard')} onGameOver={(s,g)=>{ alert(`Thua rồi! Điểm: ${s}, Vàng: ${g}`); const u={...user}; u.gold+=g; setUser(u); MockDB.updateUser(u.uid, u); setView('dashboard'); }} />;

            return (
                <div className="min-h-screen p-4 max-w-6xl mx-auto relative">
                    <div className="cloud-bg"><div className="cloud" style={{width:200,height:200,top:'10%'}}></div></div>
                    
                    {/* DASHBOARD HEADER */}
                    <div className="flex justify-between items-start mb-8 relative z-10">
                        <div className="flex items-center gap-4 bg-white/80 p-4 rounded-2xl shadow border-2 border-white">
                            <div className="w-16 h-16 rounded-full bg-gray-300 overflow-hidden">{user.avatar && <img src={user.avatar} className="w-full h-full object-cover"/>}</div>
                            <div>
                                <h1 className="font-bold text-xl">{user.nickname}</h1>
                                <div className="text-sm font-bold text-yellow-600">Gold: {user.gold}</div>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            {user.role === 'admin' && <button onClick={()=>setView('admin')} className="bg-black text-white p-3 rounded-xl font-bold">Admin Panel</button>}
                            <button onClick={()=>setShowSettings(true)} className="bg-white p-3 rounded-xl shadow"><Settings/></button>
                        </div>
                    </div>

                    {/* DASHBOARD CONTENT */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 relative z-10">
                        {/* Play Zone */}
                        <div className="md:col-span-2 bg-white/60 p-8 rounded-3xl shadow-xl flex flex-col items-center justify-center min-h-[400px]">
                            {user.role === 'admin' ? 
                                <div className="text-center"><h2 className="text-3xl font-bold">KHU VỰC QUẢN TRỊ</h2><p>Admin không được chơi game.</p></div> : 
                                <>
                                    <div className="animate-bounce mb-8"><Plane size={100} color="#3B82F6"/></div>
                                    <button onClick={()=>setView('game')} className="bg-blue-600 text-white text-2xl font-bold py-4 px-12 rounded-full shadow-lg hover:scale-110 transition">CHIẾN ĐẤU</button>
                                </>
                            }
                        </div>

                        {/* Sidebar */}
                        <div className="space-y-4">
                            {/* EVENT MODULE */}
                            <Module_Event user={user} config={config} onClaimEvent={handleClaimEvent} />
                            
                            <button onClick={()=>setView('shop')} className="w-full bg-white p-6 rounded-2xl shadow hover:scale-105 transition flex items-center justify-between">
                                <div className="flex items-center gap-4"><div className="bg-yellow-100 p-3 rounded-xl text-yellow-600"><ShoppingCart/></div><span className="font-bold">Cửa hàng</span></div>
                            </button>
                            <div className="bg-white/80 p-6 rounded-2xl shadow">
                                <h3 className="font-bold mb-4 flex items-center gap-2"><Zap size={18}/> Kho đồ</h3>
                                <div className="grid grid-cols-2 gap-2 text-center text-sm font-bold">
                                    <div className="bg-purple-100 p-2 rounded text-purple-700">Shields: {user.inventory.shields}</div>
                                    <div className="bg-red-100 p-2 rounded text-red-700">Bombs: {user.inventory.bombs}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* OVERLAYS */}
                    {view === 'shop' && <div className="fixed inset-0 z-40 bg-black/50 flex items-center justify-center p-4"><Module_Shop user={user} config={config} onPurchase={handlePurchase} onBack={()=>setView('dashboard')} /></div>}
                    {view === 'admin' && <Module_Admin user={user} config={config} allUsers={MockDB.users} onUpdateConfig={(nc)=>setConfig({...config, ...nc})} onUpdateUser={(id, d)=>MockDB.updateUser(id, d)} onExit={()=>setView('dashboard')} />}
                    {showSettings && <Module_UserSettings user={user} onUpdate={(d)=>{const u={...user,...d}; setUser(u); MockDB.updateUser(u.uid, u);}} onLogout={handleLogout} onClose={()=>setShowSettings(false)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
