<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sky Guardian - Modular Architecture</title>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
        body { font-family: 'Nunito', sans-serif; background: #e0f2fe; }
        .cloud-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 100%); overflow: hidden; }
        .cloud { position: absolute; background: rgba(255, 255, 255, 0.8); border-radius: 50%; animation: floatCloud linear infinite; }
        @keyframes floatCloud { 0% { transform: translateX(-200px); } 100% { transform: translateX(100vw); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .canvas-container { border: 4px solid #fff; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .spinner { width: 24px; height: 24px; border: 4px solid rgba(0,0,0,0.1); border-left-color: #09f; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .avatar-container:hover .avatar-overlay { opacity: 1; }
        .event-card { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================================================================
        // MODULE 0: CORE & CONFIG & UTILS
        // ==========================================================================================
        const firebaseConfig = { apiKey: "AIzaSyD-FAKE-KEY", authDomain: "demo.firebaseapp.com", projectId: "demo", storageBucket: "demo.appspot.com", messagingSenderId: "123", appId: "1:123:web:abc" };
        if (!firebase.apps.length) try { firebase.initializeApp(firebaseConfig); } catch (e) { console.warn("Firebase Mock Mode"); }
        const auth = firebase.auth(); const db = firebase.firestore();
        const apiKey = ""; 

        const DEFAULT_CONFIG = {
            planes: [
                { id: 'p1', name: 'Mô hình giấy', speed: 4, hp: 3, price: 0, color: '#EF4444', image: null }, 
                { id: 'p2', name: 'Chiến cơ Ghibli', speed: 6, hp: 5, price: 1000, color: '#3B82F6', image: null }, 
                { id: 'p3', name: 'Hủy diệt hạm', speed: 8, hp: 8, price: 5000, color: '#10B981', image: null } 
            ],
            items: [
                { id: 'w1', name: 'Súng máy cơ bản', type: 'weapon', price: 0, value: 1, fireRate: 20, bulletSpeed: 10, image: null, description: 'Súng mặc định.' },
                { id: 'w2', name: 'Laser Plasma', type: 'weapon', price: 2000, value: 1, fireRate: 5, bulletSpeed: 30, image: null, description: 'Bắn tia laser cực nhanh nhưng yếu.' },
                { id: 's1', name: 'Khiên Plasma', type: 'shield', price: 200, value: 5, image: null, description: 'Bảo vệ trong 5 giây.' },
                { id: 'b1', name: 'Bom Nguyên Tử', type: 'bomb', price: 500, value: 10, radius: 10, image: null, description: 'Xóa sổ diện rộng.' },
                { id: 'm1', name: 'Tên Lửa Tầm Nhiệt', type: 'missile', price: 1500, value: 4, fireRate: 60, bulletSpeed: 5, trackingTime: 3, image: null, description: 'Dí theo mục tiêu 3s.' }
            ],
            events: [
                { id: 'ev1', name: 'Khuyến mãi nạp đầu', description: 'Tặng ngay 5000 vàng cho lần đăng nhập đầu tiên trong ngày!', active: true, bonusGold: 5000, type: 'login_bonus' }
            ]
        };

        const generateGeminiContent = async (prompt) => { return "AI: Đang bảo trì."; };

        const IconBase = ({ d, size = 24, color = "currentColor", className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {Array.isArray(d) ? d.map((path, i) => <path key={i} d={path} />) : <path d={d} />}
            </svg>
        );
        const Icons = {
            Plane: (p) => <IconBase {...p} d="M2 12h20M12 2v20M4.5 10l-2.5 2 2.5 2M19.5 10l2.5 2-2.5 2" />, 
            Shield: (p) => <IconBase {...p} d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />,
            Bomb: (p) => <IconBase {...p} d={["M11 2a3 3 0 0 1 3 3v.5M7 11.5a5.5 5.5 0 1 0 10.8 1.5","M15 6l2-2"]} />,
            Zap: (p) => <IconBase {...p} d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />,
            Settings: (p) => <IconBase {...p} d={["M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z", "M12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"]} />,
            LogOut: (p) => <IconBase {...p} d={["M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4", "M16 17l5-5-5-5", "M21 12H9"]} />,
            User: (p) => <IconBase {...p} d={["M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2", "M12 3a4 4 0 1 0 0 8 4 4 0 0 0 0-8z"]} />,
            DollarSign: (p) => <IconBase {...p} d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />,
            Trophy: (p) => <IconBase {...p} d={["M8 21h8", "M12 17v4", "M7 4h10", "M17 4v3a5 5 0 0 1-10 0V4"]} />,
            ShoppingCart: (p) => <IconBase {...p} d={["M9 21a1 1 0 1 0 0 2 1 1 0 0 0 0-2z", "M20 21a1 1 0 1 0 0 2 1 1 0 0 0 0-2z", "M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"]} />,
            Play: (p) => <IconBase {...p} d="M5 3l14 9-14 9V3z" />,
            Edit: (p) => <IconBase {...p} d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />,
            Trash2: (p) => <IconBase {...p} d={["M3 6h18", "M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6", "M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"]} />,
            ShieldCheck: (p) => <IconBase {...p} d={["M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z", "M9 12l2 2 4-4"]} />,
            Lock: (p) => <IconBase {...p} d={["M4 11a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-9z", "M7 11V7a5 5 0 0 1 10 0v4"]} />,
            Mail: (p) => <IconBase {...p} d={["M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z", "M22 6l-10 7L2 6"]} />,
            Sparkles: (p) => <IconBase {...p} d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />,
            Camera: (p) => <IconBase {...p} d={["M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z", "M12 13a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"]} />, 
            Plus: (p) => <IconBase {...p} d={["M12 5v14", "M5 12h14"]} />,
            Upload: (p) => <IconBase {...p} d={["M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4", "M17 8l-5-5-5 5", "M12 3v12"]} />,
            Weapon: (p) => <IconBase {...p} d={["M6 9H2v2h4V9zm8-2h-2v4h2V7zm4-4h-2v8h2V3zM4 19h10v2H4v-2zm16-6h-4v2h4v-2z"]} />,
            Gift: (p) => <IconBase {...p} d={["M20 12v10H4V12", "M2 7h20v5H2z", "M12 22V7", "M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z", "M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"]} />,
            Missile: (p) => <IconBase {...p} d={["M12 2l-2 6h4l-2-6z", "M10 8h4v10h-4z", "M8 18l4 4 4-4"]} />, 
        };

        const { useState, useEffect, useRef, useMemo } = React;
        const { Plane, Shield, Bomb, Zap, Settings, LogOut, User, DollarSign, Trophy, ShoppingCart, Play, Edit, Trash2, ShieldCheck, Lock, Mail, Sparkles, Camera, Plus, Upload, Weapon, Gift, Missile } = Icons; 

        // ==========================================================================================
        // MODULE 1: USER MANAGEMENT & DATABASE
        // ==========================================================================================
        const MockDB = {
            users: {
                'admin_uid': { uid: 'admin_uid', username: 'admin', password: 'qazwsx@12A', email: 'admin@sky.com', role: 'admin', nickname: 'Admin Bất Tử', avatar: null, gold: 999999, level: 99, title: 'Trùm Cuối', planes: ['p1', 'p2', 'p3'], currentPlane: 'p3', currentWeapon: 'w1', inventory: { shields: 99, bombs: 99 }, eventsParticipated: [] }
            },
            currentUser: null,
            login: async (u, p) => {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        const usersArr = Object.values(MockDB.users);
                        const found = usersArr.find(usr => usr.username === u);
                        if (found && found.password === p) {
                            if (!found.currentWeapon) found.currentWeapon = 'w1';
                            if (!found.eventsParticipated) found.eventsParticipated = [];
                            MockDB.currentUser = found;
                            resolve(found);
                        } else reject("Sai thông tin!");
                    }, 500);
                });
            },
            register: async (u, p, e, avatar = null) => {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        if (Object.values(MockDB.users).some(usr => usr.username === u)) return reject("Trùng username!");
                        const newUser = { uid: 'u_'+Date.now(), username: u, password: p, email: e, role: 'user', nickname: u, avatar: avatar, gold: 500, level: 1, title: 'Tân Binh', exp: 0, planes: ['p1'], currentPlane: 'p1', currentWeapon: 'w1', inventory: { shields: 1, bombs: 4 }, eventsParticipated: [] };
                        MockDB.users[newUser.uid] = newUser;
                        MockDB.currentUser = newUser;
                        resolve(newUser);
                    }, 500);
                });
            },
            updateUser: (uid, data) => { if (MockDB.users[uid]) MockDB.users[uid] = { ...MockDB.users[uid], ...data }; },
            deleteUser: (uid) => { delete MockDB.users[uid]; },
            changePassword: async (uid, old, newP) => { return Promise.resolve(true); },
            resetPassword: async (e) => { return Promise.resolve("Đã gửi mail!"); }
        };

        const Module_Auth = ({ onLogin }) => {
            const [mode, setMode] = useState('login'); 
            const [form, setForm] = useState({ u: '', p: '', e: '' });
            const [msg, setMsg] = useState({ type: '', text: '' });

            const submit = async (e) => {
                e.preventDefault();
                setMsg({ type: 'info', text: 'Đang xử lý...' });
                try {
                    let user;
                    if (mode === 'forgot') { setMsg({ type: 'success', text: await MockDB.resetPassword(form.e) }); return; }
                    if (mode === 'register') user = await MockDB.register(form.u, form.p, form.e);
                    else user = await MockDB.login(form.u, form.p);
                    onLogin(user);
                } catch (err) { setMsg({ type: 'error', text: err }); }
            };

            return (
                <div className="flex items-center justify-center min-h-screen relative z-10">
                    <div className="bg-white/90 backdrop-blur p-8 rounded-2xl shadow-xl w-96 border-2 border-white">
                        <div className="text-center mb-6"><div className="w-20 h-20 bg-blue-500 rounded-full mx-auto mb-4 flex items-center justify-center shadow-lg animate-bounce"><Plane size={40} color="white" /></div><h1 className="text-3xl font-bold text-gray-800">Sky Guardian</h1></div>
                        {msg.text && <div className={`p-2 rounded mb-4 text-sm font-bold ${msg.type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>{msg.text}</div>}
                        <form onSubmit={submit} className="space-y-4">
                            {mode !== 'forgot' && <div><label className="block text-sm font-bold text-gray-600">Username</label><input className="w-full p-2 border rounded" value={form.u} onChange={e=>setForm({...form, u: e.target.value})} required /></div>}
                            {(mode === 'register' || mode === 'forgot') && <div><label className="block text-sm font-bold text-gray-600">Email</label><input type="email" className="w-full p-2 border rounded" value={form.e} onChange={e=>setForm({...form, e: e.target.value})} required /></div>}
                            {mode !== 'forgot' && <div><label className="block text-sm font-bold text-gray-600">Password</label><input type="password" className="w-full p-2 border rounded" value={form.p} onChange={e=>setForm({...form, p: e.target.value})} required /></div>}
                            <button className="w-full py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">{mode === 'login' ? 'Đăng Nhập' : (mode === 'register' ? 'Đăng Ký' : 'Khôi Phục')}</button>
                        </form>
                        <div className="mt-4 text-center text-sm space-x-2">
                            {mode !== 'login' && <button onClick={()=>setMode('login')} className="text-blue-500 hover:underline">Đăng nhập</button>}
                            {mode !== 'register' && <button onClick={()=>setMode('register')} className="text-blue-500 hover:underline">Đăng ký</button>}
                            {mode !== 'forgot' && <button onClick={()=>setMode('forgot')} className="text-gray-500 hover:underline">Quên pass?</button>}
                        </div>
                    </div>
                </div>
            );
        };

        const Module_UserSettings = ({ user, onUpdate, onClose, onLogout }) => {
            const [activeSection, setActiveSection] = useState('profile');
            const [newName, setNewName] = useState(user.nickname);
            const [newEmail, setNewEmail] = useState(user.email);
            
            const [oldPass, setOldPass] = useState('');
            const [newPass, setNewPass] = useState('');
            const [confirmPass, setConfirmPass] = useState('');
            const [passError, setPassError] = useState('');
            const [passSuccess, setPassSuccess] = useState('');

            const fileInputRef = useRef(null);

            const handleAvatarChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        onUpdate({ avatar: reader.result });
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleChangePassword = async () => {
                setPassError('');
                setPassSuccess('');
                if (newPass !== confirmPass) {
                    setPassError('Mật khẩu mới không khớp!');
                    return;
                }
                if (newPass.length < 6) {
                    setPassError('Mật khẩu mới phải từ 6 ký tự!');
                    return;
                }

                try {
                    await MockDB.changePassword(user.uid, oldPass, newPass);
                    setPassSuccess('Đổi mật khẩu thành công!');
                    setOldPass('');
                    setNewPass('');
                    setConfirmPass('');
                } catch (err) {
                    setPassError(err);
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl shadow-2xl w-[500px] overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="bg-gray-100 p-4 border-b flex justify-between items-center">
                            <h2 className="text-xl font-bold flex items-center gap-2"><Settings className="text-gray-600"/> Cài đặt Tài Khoản</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600">&times;</button>
                        </div>
                        <div className="flex border-b">
                            <button onClick={() => setActiveSection('profile')} className={`flex-1 py-3 font-bold text-sm ${activeSection === 'profile' ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-gray-500 hover:bg-gray-50'}`}>Hồ sơ & Avatar</button>
                            <button onClick={() => setActiveSection('security')} className={`flex-1 py-3 font-bold text-sm ${activeSection === 'security' ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-gray-500 hover:bg-gray-50'}`}>Bảo mật & Mật khẩu</button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            {activeSection === 'profile' && (
                                <div className="space-y-6">
                                    <div className="flex flex-col items-center">
                                        <div className="relative w-24 h-24 rounded-full bg-gray-200 overflow-hidden cursor-pointer avatar-container shadow-inner border-4 border-white" onClick={() => fileInputRef.current.click()}>
                                            {user.avatar ? <img src={user.avatar} alt="Avatar" className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center bg-gradient-to-tr from-blue-400 to-purple-500 text-white text-3xl font-bold">{user.nickname.charAt(0).toUpperCase()}</div>}
                                            <div className="avatar-overlay absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 transition-opacity duration-200"><Camera className="text-white" size={24} /></div>
                                        </div>
                                        <input type="file" ref={fileInputRef} onChange={handleAvatarChange} className="hidden" accept="image/*" />
                                        <span className="text-xs text-blue-500 mt-2 cursor-pointer hover:underline" onClick={() => fileInputRef.current.click()}>Đổi Avatar</span>
                                    </div>
                                    <div className="space-y-4">
                                        <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Tên hiển thị</label><input value={newName} onChange={(e) => setNewName(e.target.value)} className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-200 outline-none transition" /></div>
                                        <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Email</label><input value={newEmail} onChange={(e) => setNewEmail(e.target.value)} className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-200 outline-none transition" /></div>
                                    </div>
                                    <button onClick={() => { onUpdate({ nickname: newName, email: newEmail }); alert("Đã cập nhật hồ sơ!"); }} className="w-full py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 shadow-md transition transform hover:scale-[1.02]">Lưu thay đổi hồ sơ</button>
                                </div>
                            )}
                            {activeSection === 'security' && (
                                <div className="space-y-4">
                                    {passError && <div className="bg-red-50 text-red-600 p-2 rounded text-sm border border-red-200">{passError}</div>}
                                    {passSuccess && <div className="bg-green-50 text-green-600 p-2 rounded text-sm border border-green-200">{passSuccess}</div>}
                                    <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Mật khẩu hiện tại</label><input type="password" value={oldPass} onChange={(e) => setOldPass(e.target.value)} className="w-full border p-2 rounded focus:ring-2 focus:ring-red-200 outline-none transition" placeholder="Nhập mật khẩu cũ..." /></div>
                                    <div className="border-t pt-4">
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Mật khẩu mới</label>
                                        <input type="password" value={newPass} onChange={(e) => setNewPass(e.target.value)} className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-200 outline-none transition mb-2" placeholder="Mật khẩu mới..." />
                                        <input type="password" value={confirmPass} onChange={(e) => setConfirmPass(e.target.value)} className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-200 outline-none transition" placeholder="Nhập lại mật khẩu mới..." />
                                    </div>
                                    <button onClick={handleChangePassword} className="w-full py-2 bg-gray-800 text-white rounded font-bold hover:bg-black shadow-md transition transform hover:scale-[1.02]">Đổi Mật Khẩu</button>
                                </div>
                            )}
                        </div>
                        <div className="p-4 bg-gray-50 border-t flex justify-between items-center">
                            <button onClick={onLogout} className="text-red-600 hover:bg-red-50 px-3 py-1 rounded font-bold text-sm border border-transparent hover:border-red-200 transition"><LogOut size={14} className="inline mr-1"/> Đăng xuất</button>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-800 text-sm">Đóng</button>
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================================================================
        // MODULE 2: BASE GAME
        // ==========================================================================================
        const Module_Game = ({ user, config, onExit, onGameOver }) => {
            const canvasRef = useRef(null);
            const requestRef = useRef();
            const planeImagesRef = useRef({});
            
            const currentPlaneStats = config.planes.find(p => p.id === user.currentPlane) || config.planes[0];
            const currentWeapon = config.items.find(i => i.id === user.currentWeapon) || config.items[0];

            useEffect(() => {
                config.planes.forEach(p => { if (p.image) { const img = new Image(); img.src = p.image; planeImagesRef.current[p.id] = img; }});
            }, [config]);

            useEffect(() => {
                document.body.style.overflow = 'hidden';
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth > 600 ? 600 : window.innerWidth; canvas.height = window.innerHeight;

                let state = {
                    player: { x: canvas.width/2, y: canvas.height-100, w: 50, h: 50, hp: currentPlaneStats.hp || 3, color: currentPlaneStats.color },
                    bullets: [], enemies: [], particles: [], score: 0, gold: 0, frames: 0, gameOver: false
                };

                const keys = {};
                window.onkeydown = e => keys[e.code] = true; window.onkeyup = e => keys[e.code] = false;
                
                const loop = () => {
                    if (state.gameOver) {
                        ctx.fillStyle = 'rgba(0,0,0,0.7)'; ctx.fillRect(0,0,canvas.width, canvas.height);
                        ctx.fillStyle = 'white'; ctx.textAlign = 'center'; ctx.font = '30px Nunito'; ctx.fillText('GAME OVER', canvas.width/2, canvas.height/2);
                        return;
                    }
                    state.frames++;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    if (keys['ArrowLeft']) state.player.x -= currentPlaneStats.speed;
                    if (keys['ArrowRight']) state.player.x += currentPlaneStats.speed;
                    if (keys['ArrowUp']) state.player.y -= currentPlaneStats.speed;
                    if (keys['ArrowDown']) state.player.y += currentPlaneStats.speed;

                    if (planeImagesRef.current[user.currentPlane]) ctx.drawImage(planeImagesRef.current[user.currentPlane], state.player.x - 25, state.player.y - 25, 50, 50);
                    else { ctx.fillStyle = state.player.color; ctx.fillRect(state.player.x - 25, state.player.y - 25, 50, 50); }

                    const weaponFireRate = currentWeapon.fireRate || 20;
                    if (state.frames % weaponFireRate === 0) {
                        const dmg = currentWeapon.value || 1;
                        const color = currentWeapon.type === 'missile' ? 'red' : (currentWeapon.id === 'w2' ? '#0f0' : 'orange');
                        const w = currentWeapon.type === 'missile' ? 8 : 4;
                        const bSpeed = currentWeapon.bulletSpeed || 10;
                        state.bullets.push({ x: state.player.x, y: state.player.y - 20, w: w, h: 10, dmg: dmg, color: color, type: currentWeapon.type, tracking: currentWeapon.trackingTime, speed: bSpeed });
                    }

                    for (let i = state.bullets.length - 1; i >= 0; i--) {
                        let b = state.bullets[i];
                        if (b.type === 'missile' && b.tracking > 0 && state.enemies.length > 0) {
                            const target = state.enemies[0];
                            if (target.x > b.x) b.x += 2;
                            if (target.x < b.x) b.x -= 2;
                        }
                        
                        b.y -= b.speed; 
                        ctx.fillStyle = b.color; 
                        ctx.fillRect(b.x, b.y, b.w, b.h);
                        if(b.y < 0) state.bullets.splice(i, 1);
                    }

                    if (state.frames % 60 === 0) state.enemies.push({ x: Math.random() * canvas.width, y: -20, w: 30, h: 30, hp: 2 });
                    
                    for (let i = state.enemies.length - 1; i >= 0; i--) {
                        let e = state.enemies[i];
                        e.y += 3; ctx.fillStyle = 'gray'; ctx.fillRect(e.x, e.y, e.w, e.h);
                        
                        for (let j = state.bullets.length - 1; j >= 0; j--) {
                            let b = state.bullets[j];
                            if (Math.hypot(b.x - e.x, b.y - e.y) < 20) {
                                e.hp -= b.dmg; 
                                state.bullets.splice(j, 1);
                                if (e.hp <= 0) { 
                                    state.enemies.splice(i, 1); 
                                    state.score += 100; 
                                    state.gold += 5; 
                                    break; 
                                }
                            }
                        }

                        if (e.hp > 0 && Math.hypot(state.player.x - e.x, state.player.y - e.y) < 30) {
                            state.player.hp--; 
                            state.enemies.splice(i, 1);
                            if (state.player.hp <= 0) { state.gameOver = true; onGameOver(state.score, state.gold); }
                        }
                    }

                    ctx.fillStyle = 'black'; ctx.textAlign = 'left'; ctx.font = '20px Nunito'; ctx.fillText(`Score: ${state.score} | HP: ${state.player.hp}`, 10, 30);

                    requestRef.current = requestAnimationFrame(loop);
                };
                requestRef.current = requestAnimationFrame(loop);
                return () => { document.body.style.overflow = 'auto'; cancelAnimationFrame(requestRef.current); };
            }, []);

            return <div className="fixed inset-0 bg-black flex items-center justify-center"><div className="canvas-container bg-blue-200"><canvas ref={canvasRef}></canvas></div><button onClick={onExit} className="absolute top-4 right-4 bg-red-500 text-white p-2 rounded">Thoát</button></div>;
        };

        // ==========================================================================================
        // MODULE 3: SHOP & INVENTORY
        // ==========================================================================================
        const Module_Shop = ({ user, config, onPurchase, onBack }) => {
            const weapons = config.items.filter(i => i.type === 'weapon' || i.type === 'missile');
            const supports = config.items.filter(i => i.type !== 'weapon' && i.type !== 'missile');

            const ItemCard = ({ item, isPlane = false }) => {
                const isOwned = isPlane ? user.planes.includes(item.id) : false;
                const isEquipped = isPlane ? user.currentPlane === item.id : user.currentWeapon === item.id;
                
                return (
                    <div className={`bg-white border rounded-xl p-4 flex flex-col justify-between ${isEquipped ? 'border-green-500 bg-green-50' : ''}`}>
                        <div className="text-center mb-2">
                            <div className="h-16 flex items-center justify-center">{item.image ? <img src={item.image} className="h-full object-contain"/> : (isPlane ? <Plane/> : (item.type === 'missile' ? <Missile/> : <Weapon/>))}</div>
                            <div className="font-bold">{item.name}</div>
                            <div className="text-xs text-gray-500">
                                {isPlane ? `HP: ${item.hp} | Spd: ${item.speed}` : 
                                 item.type === 'missile' ? `Dí: ${item.trackingTime}s` :
                                 item.type === 'bomb' ? `Rộng: ${item.radius}` :
                                 item.type === 'shield' ? `Time: ${item.value}s` : `DMG: ${item.value}`}
                            </div>
                            {(item.type === 'weapon' || item.type === 'missile') && <div className="text-[10px] text-gray-400">Tốc độ bắn: {item.fireRate}</div>}
                        </div>
                        {isPlane ? (
                            isOwned ? <button disabled={isEquipped} onClick={() => onPurchase('equip_plane', item)} className="bg-blue-100 text-blue-600 w-full py-1 rounded">{isEquipped ? 'Đang dùng' : 'Trang bị'}</button>
                            : <button onClick={() => onPurchase('buy_plane', item)} className="bg-yellow-400 text-black w-full py-1 rounded">Mua {item.price}</button>
                        ) : (
                            (item.type === 'weapon' || item.type === 'missile') ? 
                            <button disabled={isEquipped} onClick={() => onPurchase('buy_item', item)} className="bg-orange-500 text-white w-full py-1 rounded">{isEquipped ? 'Đang dùng' : `Mua ${item.price}`}</button>
                            : <button onClick={() => onPurchase('buy_item', item)} className="bg-purple-500 text-white w-full py-1 rounded">Mua (+1) {item.price}</button>
                        )}
                    </div>
                );
            };

            return (
                <div className="bg-white/95 rounded-xl shadow-2xl p-6 w-full max-w-5xl h-[80vh] flex flex-col relative z-20">
                    <div className="flex justify-between border-b pb-4 mb-4">
                        <h2 className="text-2xl font-bold flex gap-2"><ShoppingCart/> Cửa Hàng</h2>
                        <div className="font-bold text-yellow-600"><DollarSign className="inline"/> {user.gold} <button onClick={onBack} className="ml-4 text-gray-500">Đóng</button></div>
                    </div>
                    <div className="overflow-y-auto space-y-6 p-2">
                        <section>
                            <h3 className="font-bold text-gray-700 mb-2">Máy Bay</h3>
                            <div className="grid grid-cols-3 gap-4">{config.planes.map(p => <ItemCard key={p.id} item={p} isPlane={true} />)}</div>
                        </section>
                        <section>
                            <h3 className="font-bold text-gray-700 mb-2">Vũ Khí (Súng & Tên Lửa)</h3>
                            <div className="grid grid-cols-3 gap-4">{weapons.map(w => <ItemCard key={w.id} item={w} />)}</div>
                        </section>
                        <section>
                            <h3 className="font-bold text-gray-700 mb-2">Hỗ Trợ (Bom & Khiên)</h3>
                            <div className="grid grid-cols-3 gap-4">{supports.map(s => <ItemCard key={s.id} item={s} />)}</div>
                        </section>
                    </div>
                </div>
            );
        };

        // ==========================================================================================
        // MODULE 4: EVENTS
        // ==========================================================================================
        const Module_Event = ({ user, config, onClaimEvent }) => {
            const activeEvents = config.events.filter(e => e.active);
            if (activeEvents.length === 0) return null;

            return (
                <div className="space-y-4">
                    {activeEvents.map(evt => {
                        const participated = user.eventsParticipated && user.eventsParticipated.includes(evt.id);
                        return (
                            <div key={evt.id} className="event-card p-4 rounded-xl shadow-lg border border-pink-200 relative overflow-hidden">
                                <div className="absolute top-0 right-0 p-2 opacity-20"><Gift size={60} /></div>
                                <div className="relative z-10">
                                    <h3 className="font-bold text-pink-800 flex items-center gap-2"><Sparkles size={16}/> {evt.name}</h3>
                                    <p className="text-xs text-pink-700 mb-3">{evt.description}</p>
                                    {participated ? (
                                        <button disabled className="bg-gray-200 text-gray-500 px-3 py-1 rounded text-xs font-bold w-full">Đã nhận</button>
                                    ) : (
                                        <button onClick={() => onClaimEvent(evt)} className="bg-pink-600 hover:bg-pink-700 text-white px-3 py-1 rounded text-xs font-bold w-full shadow animate-pulse">Nhận Quà</button>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        // ==========================================================================================
        // MODULE 5: ADMIN MANAGEMENT
        // ==========================================================================================
        const Module_Admin = ({ user, config, allUsers, onUpdateConfig, onUpdateUser, onAddUser, onDeleteUser, onExit }) => {
            const [tab, setTab] = useState('users');
            const [editUser, setEditUser] = useState(null);
            const [showAddUser, setShowAddUser] = useState(false);
            const [newUserForm, setNewUserForm] = useState({ u: '', p: '', e: '', avatar: null });
            const [editItem, setEditItem] = useState(null); 
            
            const handleUpload = (e, listName, idx) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onloadend = () => {
                    const newList = [...config[listName]];
                    newList[idx].image = reader.result;
                    onUpdateConfig({ [listName]: newList });
                };
                reader.readAsDataURL(file);
            };

            const handleUserAvatarUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setEditUser({ ...editUser, avatar: reader.result });
                    reader.readAsDataURL(file);
                }
            };

            const handleNewUserAvatarUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setNewUserForm({ ...newUserForm, avatar: reader.result });
                    reader.readAsDataURL(file);
                }
            };

            const toggleEvent = (idx) => {
                const newEvts = [...config.events];
                newEvts[idx].active = !newEvts[idx].active;
                onUpdateConfig({ events: newEvts });
            };

            const deleteItem = (idx) => {
                if(confirm('Xóa vật phẩm này?')) {
                    const newItems = [...config.items];
                    newItems.splice(idx, 1);
                    onUpdateConfig({ items: newItems });
                }
            };

            const saveItem = () => {
                const newItems = [...config.items];
                const index = newItems.findIndex(i => i.id === editItem.id);
                if (index > -1) { newItems[index] = editItem; } else { newItems.push(editItem); }
                onUpdateConfig({ items: newItems });
                setEditItem(null);
            };

            const addNewItem = () => {
                setEditItem({
                    id: 'i' + Date.now(), name: 'Vật phẩm mới', type: 'weapon', 
                    price: 500, value: 1, image: null, description: 'Mô tả...',
                    radius: 2, trackingTime: 2, fireRate: 20, bulletSpeed: 10
                });
            };

            return (
                <div className="fixed inset-0 bg-gray-900/90 z-50 flex">
                    <div className="w-64 bg-black text-white p-6">
                        <h2 className="text-xl font-bold mb-8 text-yellow-400">ADMIN PANEL</h2>
                        <nav className="space-y-4">
                            <button onClick={()=>setTab('users')} className={`block w-full text-left ${tab==='users'?'text-blue-400':''}`}>Quản lý User</button>
                            <button onClick={()=>setTab('planes')} className={`block w-full text-left ${tab==='planes'?'text-blue-400':''}`}>Máy Bay</button>
                            <button onClick={()=>setTab('items')} className={`block w-full text-left ${tab==='items'?'text-blue-400':''}`}>Vật Phẩm</button>
                            <button onClick={()=>setTab('events')} className={`block w-full text-left ${tab==='events'?'text-blue-400':''}`}>Sự Kiện</button>
                        </nav>
                        <button onClick={onExit} className="mt-8 text-red-500 border border-red-500 px-4 py-2 rounded">Thoát</button>
                    </div>
                    <div className="flex-1 bg-gray-100 p-8 overflow-y-auto text-black">
                        {tab === 'users' && (
                            <div>
                                <div className="flex justify-between items-center mb-6 border-b pb-2">
                                    <h3 className="font-bold text-xl">Danh sách User</h3>
                                    <button onClick={()=>setShowAddUser(true)} className="bg-green-600 text-white px-4 py-2 rounded font-bold"><Plus size={16} className="inline"/> Thêm User</button>
                                </div>
                                {Object.values(allUsers).map(u => (
                                    <div key={u.uid} className="bg-white p-4 mb-2 rounded shadow flex justify-between items-center">
                                        <div>
                                            <div className="font-bold">{u.nickname} <span className="text-xs text-gray-500">({u.username})</span></div>
                                            <div className="text-sm text-gray-500">{u.email} | Lvl {u.level} | {u.title || 'Không danh hiệu'}</div>
                                            <div className="text-sm font-bold text-yellow-600">Gold: {u.gold}</div>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => setEditUser({...u, newPass: ''})} className="bg-blue-100 text-blue-600 p-2 rounded hover:bg-blue-200"><Edit size={16}/></button>
                                            <button onClick={() => { if(confirm('Xóa user này?')) onDeleteUser(u.uid); }} className="bg-red-100 text-red-600 p-2 rounded hover:bg-red-200"><Trash2 size={16}/></button>
                                        </div>
                                    </div>
                                ))}
                                {showAddUser && (
                                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
                                        <div className="bg-white p-6 rounded-xl shadow-xl w-96">
                                            <h3 className="font-bold text-lg mb-4">Thêm User Mới</h3>
                                            <div className="flex flex-col items-center mb-4">
                                                <div className="w-20 h-20 rounded-full bg-gray-200 overflow-hidden border border-gray-300 relative cursor-pointer" onClick={() => document.getElementById('new-user-avatar').click()}>
                                                    {newUserForm.avatar ? <img src={newUserForm.avatar} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center font-bold text-gray-400"><Camera size={20} /></div>}
                                                </div>
                                                <input type="file" id="new-user-avatar" hidden accept="image/*" onChange={handleNewUserAvatarUpload} />
                                                <span className="text-xs text-blue-500 mt-1 cursor-pointer" onClick={() => document.getElementById('new-user-avatar').click()}>Thêm Avatar</span>
                                            </div>
                                            <input className="border w-full p-2 mb-2 rounded" placeholder="Username" value={newUserForm.u} onChange={e=>setNewUserForm({...newUserForm, u: e.target.value})} />
                                            <input className="border w-full p-2 mb-2 rounded" placeholder="Password" type="password" value={newUserForm.p} onChange={e=>setNewUserForm({...newUserForm, p: e.target.value})} />
                                            <input className="border w-full p-2 mb-4 rounded" placeholder="Email" value={newUserForm.e} onChange={e=>setNewUserForm({...newUserForm, e: e.target.value})} />
                                            <div className="flex justify-end gap-2">
                                                <button onClick={()=>setShowAddUser(false)} className="text-gray-500 px-4 py-2">Hủy</button>
                                                <button onClick={()=>{ onAddUser(newUserForm); setShowAddUser(false); setNewUserForm({u:'',p:'',e:'', avatar: null}); }} className="bg-green-600 text-white px-4 py-2 rounded">Tạo</button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                {editUser && (
                                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
                                        <div className="bg-white p-6 rounded-xl shadow-xl w-96 animate-in fade-in zoom-in duration-200 overflow-y-auto max-h-[80vh]">
                                            <h3 className="font-bold text-lg mb-4">Sửa: {editUser.username}</h3>
                                            <div className="flex flex-col items-center mb-4">
                                                <div className="w-20 h-20 rounded-full bg-gray-200 overflow-hidden border border-gray-300 relative cursor-pointer" onClick={() => document.getElementById('admin-user-avatar-upload').click()}>
                                                    {editUser.avatar ? <img src={editUser.avatar} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center font-bold text-xl text-gray-400">{editUser.nickname ? editUser.nickname.charAt(0).toUpperCase() : '?'}</div>}
                                                    <div className="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 hover:opacity-100 transition"><Camera className="text-white" size={20} /></div>
                                                </div>
                                                <input type="file" id="admin-user-avatar-upload" hidden accept="image/*" onChange={handleUserAvatarUpload} />
                                                <span className="text-xs text-blue-500 mt-1 cursor-pointer" onClick={() => document.getElementById('admin-user-avatar-upload').click()}>Đổi Avatar</span>
                                            </div>
                                            <div className="space-y-3">
                                                <div><label className="text-xs font-bold text-gray-500">Nickname</label><input className="border rounded p-2 w-full" value={editUser.nickname} onChange={e=>setEditUser({...editUser, nickname: e.target.value})} /></div>
                                                <div><label className="text-xs font-bold text-gray-500">Email</label><input className="border rounded p-2 w-full" value={editUser.email} onChange={e=>setEditUser({...editUser, email: e.target.value})} /></div>
                                                <div><label className="text-xs font-bold text-gray-500">Mật khẩu mới (Để trống nếu không đổi)</label><input className="border rounded p-2 w-full" placeholder="Nhập pass mới..." value={editUser.newPass || ''} onChange={e=>setEditUser({...editUser, newPass: e.target.value})} /></div>
                                                <div className="flex gap-2">
                                                    <div className="flex-1"><label className="text-xs font-bold text-gray-500">Gold</label><input type="number" className="border w-full rounded p-2 text-right" value={editUser.gold} onChange={e=>setEditUser({...editUser, gold: parseInt(e.target.value)})} /></div>
                                                    <div className="flex-1"><label className="text-xs font-bold text-gray-500">Level</label><input type="number" className="border rounded p-2 w-full" value={editUser.level} onChange={e=>setEditUser({...editUser, level: parseInt(e.target.value)})} /></div>
                                                </div>
                                                <div><label className="text-xs font-bold text-gray-500">Danh hiệu</label><input className="border rounded p-2 w-full" value={editUser.title || ''} onChange={e=>setEditUser({...editUser, title: e.target.value})} /></div>
                                            </div>
                                            <div className="flex justify-end gap-2 mt-6">
                                                <button onClick={() => setEditUser(null)} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">Hủy</button>
                                                <button onClick={() => { const updates = { nickname: editUser.nickname, email: editUser.email, gold: editUser.gold, level: editUser.level, title: editUser.title, avatar: editUser.avatar }; if (editUser.newPass) updates.password = editUser.newPass; onUpdateUser(editUser.uid, updates); setEditUser(null); }} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold">Lưu</button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        {tab === 'planes' && (
                            <div>
                                <h3 className="font-bold text-xl mb-4">Danh sách Máy Bay</h3>
                                <div className="grid grid-cols-2 gap-4">
                                    {config.planes.map((p, i) => (
                                        <div key={p.id} className="bg-white p-4 rounded shadow">
                                            <div className="flex gap-2 mb-2">
                                                <div className="w-10 h-10 border relative cursor-pointer" onClick={()=>document.getElementById(`up_p_${i}`).click()}>
                                                    {p.image ? <img src={p.image} className="w-full h-full object-contain"/> : <span className="text-xs">Upload</span>}
                                                    <input type="file" id={`up_p_${i}`} hidden onChange={(e)=>handleUpload(e, 'planes', i)} />
                                                </div>
                                                <input className="font-bold border-b w-full" value={p.name} onChange={(e)=>{const n=[...config.planes];n[i].name=e.target.value;onUpdateConfig({planes:n})}} />
                                            </div>
                                            <div className="grid grid-cols-2 gap-2 text-sm">
                                                <div>Speed: <input className="border w-full p-1" type="number" value={p.speed} onChange={(e)=>{const n=[...config.planes];n[i].speed=Number(e.target.value);onUpdateConfig({planes:n})}} /></div>
                                                <div>HP: <input className="border w-full p-1" type="number" value={p.hp} onChange={(e)=>{const n=[...config.planes];n[i].hp=Number(e.target.value);onUpdateConfig({planes:n})}} /></div>
                                                <div>Price: <input className="border w-full p-1" type="number" value={p.price} onChange={(e)=>{const n=[...config.planes];n[i].price=Number(e.target.value);onUpdateConfig({planes:n})}} /></div>
                                            </div>
                                        </div>
                                    ))}
                                    <button onClick={()=>onUpdateConfig({planes:[...config.planes, {id:'p'+Date.now(), name:'New Plane', speed:5, hp:5, price:1000}]})} className="bg-green-500 text-white rounded p-4 flex items-center justify-center font-bold text-xl">+</button>
                                </div>
                            </div>
                        )}
                        {tab === 'items' && (
                            <div>
                                <div className="flex justify-between items-center mb-6 border-b pb-2">
                                    <h3 className="font-bold text-xl">Danh sách Vật Phẩm</h3>
                                    <button onClick={addNewItem} className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded font-bold"><Plus size={16} className="inline"/> Thêm Vật Phẩm</button>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    {config.items.map((it, i) => (
                                        <div key={it.id} className="bg-white p-4 rounded shadow relative group flex flex-col justify-between">
                                            <button onClick={()=>deleteItem(i)} className="absolute top-2 right-2 text-red-500 bg-red-100 p-1 rounded hover:bg-red-200"><Trash2 size={14}/></button>
                                            <div className="flex gap-4 mb-2">
                                                <div className="w-16 h-16 border rounded bg-gray-50 flex items-center justify-center overflow-hidden">
                                                    {it.image ? <img src={it.image} className="w-full h-full object-contain"/> : (it.type==='missile' ? <Missile/> : (it.type==='weapon' ? <Weapon/> : (it.type==='shield'?<Shield/>:<Bomb/>)))}
                                                </div>
                                                <div>
                                                    <div className="font-bold text-lg">{it.name}</div>
                                                    <div className="text-xs text-gray-500 capitalize">{it.type === 'weapon' ? 'Súng' : (it.type === 'missile' ? 'Tên Lửa' : (it.type === 'shield' ? 'Khiên' : 'Bom'))}</div>
                                                    <div className="text-sm font-bold text-yellow-600">{it.price} Gold</div>
                                                </div>
                                            </div>
                                            <div className="text-xs text-gray-600 mb-2">
                                                {(it.type === 'weapon' || it.type === 'missile') && `DMG: ${it.value} | FR: ${it.fireRate}`}
                                                {it.type === 'shield' && `Thời gian: ${it.value}s`}
                                                {it.type === 'bomb' && `Sức nổ: ${it.value} | Rộng: ${it.radius}`}
                                            </div>
                                            <button onClick={()=>setEditItem(it)} className="bg-blue-100 text-blue-600 w-full py-1 rounded text-sm font-bold hover:bg-blue-200">Sửa</button>
                                        </div>
                                    ))}
                                </div>
                                {editItem && (
                                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
                                        <div className="bg-white p-6 rounded-xl shadow-xl w-96 animate-in fade-in zoom-in duration-200">
                                            <h3 className="font-bold text-lg mb-4">Chỉnh sửa / Tạo Vật Phẩm</h3>
                                            <div className="flex justify-center mb-4">
                                                <div className="w-20 h-20 bg-gray-100 rounded border border-dashed border-gray-400 flex items-center justify-center cursor-pointer relative overflow-hidden" onClick={()=>document.getElementById('edit-item-img').click()}>
                                                    {editItem.image ? <img src={editItem.image} className="w-full h-full object-contain"/> : <span className="text-xs text-gray-400">Ảnh PNG</span>}
                                                    <input type="file" id="edit-item-img" hidden accept="image/png" onChange={(e)=>{
                                                        const file = e.target.files[0];
                                                        if(file){
                                                            const reader = new FileReader();
                                                            reader.onloadend = () => setEditItem({...editItem, image: reader.result});
                                                            reader.readAsDataURL(file);
                                                        }
                                                    }} />
                                                </div>
                                            </div>
                                            <div className="space-y-3">
                                                <div><label className="text-xs font-bold text-gray-500">Tên vật phẩm</label><input className="border rounded p-2 w-full" value={editItem.name} onChange={e=>setEditItem({...editItem, name: e.target.value})} /></div>
                                                <div>
                                                    <label className="text-xs font-bold text-gray-500">Loại</label>
                                                    <select className="border rounded p-2 w-full" value={editItem.type} onChange={e=>setEditItem({...editItem, type: e.target.value})}>
                                                        <option value="weapon">Súng (Weapon)</option>
                                                        <option value="missile">Tên Lửa (Missile)</option>
                                                        <option value="shield">Khiên (Shield)</option>
                                                        <option value="bomb">Bom (Bomb)</option>
                                                    </select>
                                                </div>
                                                <div className="flex gap-2">
                                                    <div className="flex-1"><label className="text-xs font-bold text-gray-500">Giá tiền</label><input type="number" className="border w-full p-1 text-right font-bold text-yellow-600" value={editItem.price} onChange={e=>setEditItem({...editItem, price: parseInt(e.target.value)})} /></div>
                                                    {(editItem.type === 'weapon' || editItem.type === 'missile' || editItem.type === 'bomb') && (
                                                        <div className="flex-1"><label className="text-xs font-bold text-gray-500">Sát thương/Nổ</label><input type="number" className="border w-full p-1" value={editItem.value} onChange={e=>setEditItem({...editItem, value: parseInt(e.target.value)})} /></div>
                                                    )}
                                                    {editItem.type === 'shield' && (
                                                        <div className="flex-1"><label className="text-xs font-bold text-gray-500">Thời gian (s)</label><input type="number" className="border w-full p-1" value={editItem.value} onChange={e=>setEditItem({...editItem, value: parseInt(e.target.value)})} /></div>
                                                    )}
                                                </div>
                                                {(editItem.type === 'weapon' || editItem.type === 'missile') && (
                                                    <div>
                                                        <div className="mb-2"><label className="text-xs font-bold text-gray-500">Tốc độ bắn (Fire Rate - Thấp = Nhanh)</label><input type="number" className="border w-full p-1" value={editItem.fireRate || 20} onChange={e=>setEditItem({...editItem, fireRate: parseInt(e.target.value)})} /></div>
                                                        <div><label className="text-xs font-bold text-gray-500">Tốc độ bay đạn (Projectile Speed - Cao = Nhanh)</label><input type="number" className="border w-full p-1" value={editItem.bulletSpeed || 10} onChange={e=>setEditItem({...editItem, bulletSpeed: parseInt(e.target.value)})} /></div>
                                                    </div>
                                                )}
                                                {editItem.type === 'missile' && (
                                                    <div><label className="text-xs font-bold text-gray-500">Thời gian Tracking (s)</label><input type="number" className="border w-full p-1" value={editItem.trackingTime || 2} onChange={e=>setEditItem({...editItem, trackingTime: parseInt(e.target.value)})} /></div>
                                                )}
                                                {editItem.type === 'bomb' && (
                                                    <div><label className="text-xs font-bold text-gray-500">Phạm vi nổ (Radius 2-10)</label><input type="number" min="2" max="10" className="border w-full p-1" value={editItem.radius || 2} onChange={e=>setEditItem({...editItem, radius: parseInt(e.target.value)})} /></div>
                                                )}
                                                <div><label className="text-xs font-bold text-gray-500">Mô tả</label><input className="border rounded p-2 w-full" value={editItem.description} onChange={e=>setEditItem({...editItem, description: e.target.value})} /></div>
                                            </div>
                                            <div className="flex justify-end gap-2 mt-6">
                                                <button onClick={()=>setEditItem(null)} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">Hủy</button>
                                                <button onClick={saveItem} className="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700">Lưu</button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        {tab === 'events' && (
                            <div>
                                <h3 className="font-bold text-xl mb-4">Quản lý Sự Kiện</h3>
                                {config.events.map((ev, i) => (
                                    <div key={ev.id} className="bg-white p-4 mb-2 rounded shadow flex justify-between items-center">
                                        <div>
                                            <div className="font-bold">{ev.name}</div>
                                            <div className="text-sm text-gray-500">{ev.description}</div>
                                            <div className="text-sm font-bold text-yellow-600">Thưởng: {ev.bonusGold} Gold</div>
                                        </div>
                                        <button onClick={()=>toggleEvent(i)} className={`px-4 py-2 rounded font-bold ${ev.active ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600'}`}>
                                            {ev.active ? 'Đang chạy' : 'Đã tắt'}
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('login'); 
            const [config, setConfig] = useState(DEFAULT_CONFIG);
            const [showSettings, setShowSettings] = useState(false);
            const [dbVersion, setDbVersion] = useState(0); 

            const handleLogin = (u) => { setUser(u); setView('dashboard'); };
            const handleLogout = () => { setUser(null); setView('login'); setShowSettings(false); };
            
            const handlePurchase = (type, item) => {
                const newUser = { ...user };
                if (type === 'buy_plane' || type === 'buy_item') {
                    if (user.gold >= item.price) {
                        newUser.gold -= item.price;
                        if (type === 'buy_plane') newUser.planes.push(item.id);
                        else if (item.type === 'weapon' || item.type === 'missile') { newUser.currentWeapon = item.id; } 
                        else if (item.type === 'shield') newUser.inventory.shields++;
                        else if (item.type === 'bomb') newUser.inventory.bombs++;
                        alert(`Mua thành công: ${item.name}`);
                    } else return alert("Không đủ tiền!");
                } else if (type === 'equip_plane') {
                    newUser.currentPlane = item.id;
                }
                setUser(newUser); MockDB.updateUser(user.uid, newUser);
            };

            const handleClaimEvent = (evt) => {
                const newUser = { ...user };
                newUser.gold += evt.bonusGold;
                if (!newUser.eventsParticipated) newUser.eventsParticipated = [];
                newUser.eventsParticipated.push(evt.id);
                setUser(newUser); MockDB.updateUser(user.uid, newUser);
                alert(`Đã nhận thưởng sự kiện: +${evt.bonusGold} Gold!`);
            };

            const handleUpdateUser = (uid, data) => { MockDB.updateUser(uid, data); setDbVersion(v=>v+1); };
            const handleAddUser = (form) => { MockDB.register(form.u, form.p, form.e, form.avatar).then(() => { alert("Tạo user thành công!"); setDbVersion(v=>v+1); }).catch(e=>alert(e)); };
            const handleDeleteUser = (uid) => { MockDB.deleteUser(uid); setDbVersion(v=>v+1); };

            if (!user) return <Module_Auth onLogin={handleLogin} />;
            if (view === 'game') return <Module_Game user={user} config={config} onExit={()=>setView('dashboard')} onGameOver={(s,g)=>{ alert(`Thua rồi! Điểm: ${s}, Vàng: ${g}`); const u={...user}; u.gold+=g; setUser(u); MockDB.updateUser(u.uid, u); setView('dashboard'); }} />;

            return (
                <div className="min-h-screen p-4 max-w-6xl mx-auto relative">
                    <div className="cloud-bg"><div className="cloud" style={{width:200,height:200,top:'10%'}}></div></div>
                    <div className="flex justify-between items-start mb-8 relative z-10">
                        <div className="flex items-center gap-4 bg-white/80 p-4 rounded-2xl shadow border-2 border-white">
                            <div className="w-16 h-16 rounded-full bg-gray-300 overflow-hidden">{user.avatar ? <img src={user.avatar} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center font-bold text-gray-500 text-xl">{user.nickname.charAt(0).toUpperCase()}</div>}</div>
                            <div>
                                <h1 className="font-bold text-xl">{user.nickname}</h1>
                                <div className="text-sm font-bold text-yellow-600">Gold: {user.gold}</div>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            {user.role === 'admin' && <button onClick={()=>setView('admin')} className="bg-black text-white p-3 rounded-xl font-bold">Admin Panel</button>}
                            <button onClick={()=>setShowSettings(true)} className="bg-white p-3 rounded-xl shadow"><Settings/></button>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 relative z-10">
                        <div className="md:col-span-2 bg-white/60 p-8 rounded-3xl shadow-xl flex flex-col items-center justify-center min-h-[400px]">
                            {user.role === 'admin' ? 
                                <div className="text-center"><h2 className="text-3xl font-bold">KHU VỰC QUẢN TRỊ</h2><p>Admin không được chơi game.</p></div> : 
                                <>
                                    <div className="animate-bounce mb-8"><Plane size={100} color="#3B82F6"/></div>
                                    <button onClick={()=>setView('game')} className="bg-blue-600 text-white text-2xl font-bold py-4 px-12 rounded-full shadow-lg hover:scale-110 transition">CHIẾN ĐẤU</button>
                                </>
                            }
                        </div>
                        <div className="space-y-4">
                            <Module_Event user={user} config={config} onClaimEvent={handleClaimEvent} />
                            <button onClick={()=>setView('shop')} className="w-full bg-white p-6 rounded-2xl shadow hover:scale-105 transition flex items-center justify-between">
                                <div className="flex items-center gap-4"><div className="bg-yellow-100 p-3 rounded-xl text-yellow-600"><ShoppingCart/></div><span className="font-bold">Cửa hàng</span></div>
                            </button>
                            <div className="bg-white/80 p-6 rounded-2xl shadow">
                                <h3 className="font-bold mb-4 flex items-center gap-2"><Zap size={18}/> Kho đồ</h3>
                                <div className="grid grid-cols-2 gap-2 text-center text-sm font-bold">
                                    <div className="bg-purple-100 p-2 rounded text-purple-700">Shields: {user.inventory.shields}</div>
                                    <div className="bg-red-100 p-2 rounded text-red-700">Bombs: {user.inventory.bombs}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {view === 'shop' && <div className="fixed inset-0 z-40 bg-black/50 flex items-center justify-center p-4"><Module_Shop user={user} config={config} onPurchase={handlePurchase} onBack={()=>setView('dashboard')} /></div>}
                    {view === 'admin' && <Module_Admin user={user} config={config} allUsers={MockDB.users} onUpdateConfig={(nc)=>setConfig({...config, ...nc})} onUpdateUser={handleUpdateUser} onAddUser={handleAddUser} onDeleteUser={handleDeleteUser} onExit={()=>setView('dashboard')} />}
                    {showSettings && <Module_UserSettings user={user} onUpdate={(d)=>{const u={...user,...d}; setUser(u); MockDB.updateUser(u.uid, u);}} onLogout={handleLogout} onClose={()=>setShowSettings(false)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
